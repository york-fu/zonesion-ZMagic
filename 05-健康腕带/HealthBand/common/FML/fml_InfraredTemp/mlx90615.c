/*********************************************************************************************
* 文件：mlx90615.c
* 作者：zonesion
* 说明：驱动程序
* 修改：
* 注释：
*********************************************************************************************/
/*********************************************************************************************
* 头文件
*********************************************************************************************/
#include "fml_InfraredTemp/mlx90615.h"	
#include "stdio.h"
#include "delay.h"
#include "soft_iic.h"

/*********************************************************************************************
* 宏定义
*********************************************************************************************/
#define DEV_ADDR 0x5B
#define mlx90615_smb()    do { SCL1_L; delay_ms(50); SCL1_H; }while(0);
#define EE_ADDR(x)        ((0x01<<4)|((x)&0x0f))
#define RAM_ADDR(x)       ((0x02<<4)|((x)&0x0f))


/*********************************************************************************************
* 名称：mlx90615_read()
* 功能：mlx90615读数据
* 参数：reg -- 发送数据  buf -- 数组名  len -- 数组长度
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
int mlx90615_read(char reg, char *buf, int len)
{
  int i;
  I2C1_Start();
  I2C1_WriteByte(DEV_ADDR<<1 | 0);
  if (I2C1_WaitAck()) 
  {
    return -1;
  }
  I2C1_WriteByte(reg);
  if (I2C1_WaitAck()) 
  {
    return -1;
  }
  I2C1_Start();
  I2C1_WriteByte(DEV_ADDR<<1 | 1);
  if (I2C1_WaitAck()) 
  {
    return -1;
  }
  for (i=0; i<len-1; i++) 
  {
    buf[i] = I2C1_ReadByte();
    I2C1_Ack();
  }
  buf[i] = I2C1_ReadByte();
  I2C1_NoAck();
  I2C1_Stop();
  return 1;
}


/*********************************************************************************************
* 名称：mlx90615_init()
* 功能：mlx90615初始化
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
int mlx90615_init()
{
  char id[2];
  I2C1_GPIOInit();
  
  mlx90615_smb();
  
  if (mlx90615_read(EE_ADDR(0x0e), id, 2) != 1) 
  {
    printf("error: can't find ic mlx90615 \r\n");
    return -1;
  }
  else
  {
    printf("mlx90615 id : %02X%02X\r\n", id[0], id[1]);
    return 0;
  }
}

/*********************************************************************************************
* 名称：mlx90615_GetTmep()
* 功能：体温获取
* 参数：
* 返回：
* 修改：
* 注释：
*********************************************************************************************/
short mlx90615_GetTemp(float* temp)
{
  char buf[2];
  if (mlx90615_read(RAM_ADDR(0x07), buf, 2) == 1)
  {
    unsigned int value = buf[1]<<8 | buf[0];
    *temp = (value*0.02)-273.15; 
    return 0;
  }
  return -1;
}